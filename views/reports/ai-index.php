<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1"><i class="bi bi-robot me-2"></i>AI Performance Reports</h4>
        <p class="text-muted mb-0">Generate comprehensive performance analysis reports</p>
    </div>
</div>

<!-- Report Templates Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-gradient bg-primary text-white">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-0"><i class="bi bi-file-earmark-ruled me-2"></i>Report Templates</h5>
                        <small class="opacity-75">Select a template to generate your report instantly</small>
                    </div>
                    <span class="badge bg-light text-primary">
                        <i class="bi bi-lightning-fill me-1"></i>Instant Generation
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <!-- Quarterly Performance Report -->
                    <div class="col-lg-3 col-md-6">
                        <div class="card h-100 border-primary template-card" data-template="quarterly_performance">
                            <div class="card-body text-center p-4">
                                <div class="template-icon bg-primary bg-opacity-10 text-primary rounded-circle mx-auto mb-3">
                                    <i class="bi bi-bar-chart-line"></i>
                                </div>
                                <h5 class="card-title">Quarterly Performance</h5>
                                <p class="card-text text-muted small">Comprehensive quarterly KPI analysis with achievement rates, trends, and recommendations</p>
                                <ul class="list-unstyled text-start small text-muted mb-3">
                                    <li><i class="bi bi-check2 text-success me-1"></i>KPI Achievement Summary</li>
                                    <li><i class="bi bi-check2 text-success me-1"></i>Directorate Comparison</li>
                                    <li><i class="bi bi-check2 text-success me-1"></i>Risk Assessment</li>
                                </ul>
                            </div>
                            <div class="card-footer bg-transparent border-0 pb-3">
                                <button type="button" class="btn btn-primary w-100 btn-generate" data-type="quarterly_performance">
                                    <i class="bi bi-lightning me-1"></i>Generate Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Directorate Analysis -->
                    <div class="col-lg-3 col-md-6">
                        <div class="card h-100 border-success template-card" data-template="directorate_analysis">
                            <div class="card-body text-center p-4">
                                <div class="template-icon bg-success bg-opacity-10 text-success rounded-circle mx-auto mb-3">
                                    <i class="bi bi-diagram-3"></i>
                                </div>
                                <h5 class="card-title">Directorate Analysis</h5>
                                <p class="card-text text-muted small">In-depth analysis of individual directorate performance and resource utilization</p>
                                <ul class="list-unstyled text-start small text-muted mb-3">
                                    <li><i class="bi bi-check2 text-success me-1"></i>Department Metrics</li>
                                    <li><i class="bi bi-check2 text-success me-1"></i>Resource Allocation</li>
                                    <li><i class="bi bi-check2 text-success me-1"></i>Improvement Areas</li>
                                </ul>
                            </div>
                            <div class="card-footer bg-transparent border-0 pb-3">
                                <button type="button" class="btn btn-success w-100 btn-generate" data-type="directorate_analysis">
                                    <i class="bi bi-lightning me-1"></i>Generate Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Analysis -->
                    <div class="col-lg-3 col-md-6">
                        <div class="card h-100 border-info template-card" data-template="budget_analysis">
                            <div class="card-body text-center p-4">
                                <div class="template-icon bg-info bg-opacity-10 text-info rounded-circle mx-auto mb-3">
                                    <i class="bi bi-currency-dollar"></i>
                                </div>
                                <h5 class="card-title">Budget Analysis</h5>
                                <p class="card-text text-muted small">Financial performance review with CAPEX/OPEX utilization and variance analysis</p>
                                <ul class="list-unstyled text-start small text-muted mb-3">
                                    <li><i class="bi bi-check2 text-success me-1"></i>Expenditure Tracking</li>
                                    <li><i class="bi bi-check2 text-success me-1"></i>Variance Analysis</li>
                                    <li><i class="bi bi-check2 text-success me-1"></i>MFMA Compliance</li>
                                </ul>
                            </div>
                            <div class="card-footer bg-transparent border-0 pb-3">
                                <button type="button" class="btn btn-info w-100 btn-generate" data-type="budget_analysis">
                                    <i class="bi bi-lightning me-1"></i>Generate Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Assessment -->
                    <div class="col-lg-3 col-md-6">
                        <div class="card h-100 border-danger template-card" data-template="risk_assessment">
                            <div class="card-body text-center p-4">
                                <div class="template-icon bg-danger bg-opacity-10 text-danger rounded-circle mx-auto mb-3">
                                    <i class="bi bi-shield-exclamation"></i>
                                </div>
                                <h5 class="card-title">Risk Assessment</h5>
                                <p class="card-text text-muted small">Comprehensive risk evaluation with mitigation strategies and priority actions</p>
                                <ul class="list-unstyled text-start small text-muted mb-3">
                                    <li><i class="bi bi-check2 text-success me-1"></i>Risk Identification</li>
                                    <li><i class="bi bi-check2 text-success me-1"></i>Impact Analysis</li>
                                    <li><i class="bi bi-check2 text-success me-1"></i>Mitigation Plans</li>
                                </ul>
                            </div>
                            <div class="card-footer bg-transparent border-0 pb-3">
                                <button type="button" class="btn btn-danger w-100 btn-generate" data-type="risk_assessment">
                                    <i class="bi bi-lightning me-1"></i>Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Custom Report Generator -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-sliders me-2"></i>Custom Report Options
            </div>
            <div class="card-body">
                <form id="customReportForm" method="POST" action="/reports/ai/generate-template">
                    <?= csrf_field() ?>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Report Type</label>
                        <select name="report_type" id="reportType" class="form-select" required>
                            <option value="quarterly_performance">Quarterly Performance Report</option>
                            <option value="directorate_analysis">Directorate Analysis</option>
                            <option value="budget_analysis">Budget Analysis</option>
                            <option value="risk_assessment">Risk Assessment</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Quarter</label>
                        <div class="btn-group w-100" role="group">
                            <?php for ($q = 1; $q <= 4; $q++): ?>
                            <input type="radio" class="btn-check" name="quarter" id="q<?= $q ?>" value="<?= $q ?>" <?= $q == current_quarter() ? 'checked' : '' ?>>
                            <label class="btn btn-outline-secondary" for="q<?= $q ?>">Q<?= $q ?></label>
                            <?php endfor; ?>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Directorate (Optional)</label>
                        <select name="directorate_id" id="directorateId" class="form-select">
                            <option value="">Organization-wide Report</option>
                            <?php foreach ($directorates as $d): ?>
                            <option value="<?= $d['id'] ?>"><?= e($d['code']) ?> - <?= e($d['name']) ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-dark w-100" id="customGenerateBtn">
                        <i class="bi bi-gear me-1"></i>Generate Custom Report
                    </button>
                </form>

                <?php if ($hasApiKey): ?>
                <hr class="my-4">
                <div class="text-center">
                    <p class="text-muted small mb-2">Or use AI-powered generation</p>
                    <form method="POST" action="/reports/ai/generate" class="d-inline">
                        <?= csrf_field() ?>
                        <input type="hidden" name="report_type" id="aiReportType" value="quarterly_performance">
                        <input type="hidden" name="quarter" id="aiQuarter" value="<?= current_quarter() ?>">
                        <input type="hidden" name="directorate_id" id="aiDirectorate" value="">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-robot me-1"></i>Generate with OpenAI
                        </button>
                    </form>
                    <small class="text-muted d-block mt-2">
                        Uses <?= defined('OPENAI_MODEL') ? OPENAI_MODEL : 'GPT-4' ?> | 30-60 seconds
                    </small>
                </div>
                <?php else: ?>
                <hr class="my-4">
                <div class="alert alert-light border mb-0">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-info-circle text-primary me-2 mt-1"></i>
                        <div class="small">
                            <strong>AI Generation Available</strong><br>
                            Configure <code>OPENAI_API_KEY</code> in your <code>.env</code> file to enable AI-powered report generation with GPT-4.
                        </div>
                    </div>
                </div>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <!-- Generated Reports -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-file-text me-2"></i>Generated Reports
                </div>
                <span class="badge bg-secondary"><?= count($reports) ?> reports</span>
            </div>
            <div class="card-body p-0">
                <?php if (empty($reports)): ?>
                <div class="p-5 text-center text-muted">
                    <i class="bi bi-file-earmark-text fs-1 d-block mb-3 opacity-50"></i>
                    <h5 class="text-muted">No Reports Generated Yet</h5>
                    <p class="mb-3">Select a template above or use custom options to generate your first report.</p>
                    <button type="button" class="btn btn-primary btn-generate" data-type="quarterly_performance">
                        <i class="bi bi-lightning me-1"></i>Generate Quarterly Report
                    </button>
                </div>
                <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Report</th>
                                <th>Type</th>
                                <th>Scope</th>
                                <th>Generated</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($reports as $r): ?>
                            <tr>
                                <td>
                                    <a href="/reports/ai/<?= $r['id'] ?>" class="text-decoration-none fw-medium">
                                        <?= e($r['title']) ?>
                                    </a>
                                </td>
                                <td>
                                    <?php
                                    $typeColors = [
                                        'quarterly_performance' => 'primary',
                                        'directorate_analysis' => 'success',
                                        'budget_analysis' => 'info',
                                        'risk_assessment' => 'danger'
                                    ];
                                    $color = $typeColors[$r['report_type']] ?? 'secondary';
                                    ?>
                                    <span class="badge bg-<?= $color ?>">
                                        <?= ucwords(str_replace('_', ' ', $r['report_type'])) ?>
                                    </span>
                                </td>
                                <td>
                                    <?php if ($r['directorate_name']): ?>
                                    <span class="badge bg-light text-dark">
                                        <i class="bi bi-building me-1"></i><?= e($r['directorate_name']) ?>
                                    </span>
                                    <?php else: ?>
                                    <span class="text-muted small">
                                        <i class="bi bi-globe me-1"></i>Organization-wide
                                    </span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <small class="d-block"><?= format_date($r['created_at'], 'd M Y H:i') ?></small>
                                    <small class="text-muted">by <?= e($r['generated_by_name'] ?? 'System') ?></small>
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <a href="/reports/ai/<?= $r['id'] ?>" class="btn btn-outline-primary" title="View Report">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="/reports/ai/<?= $r['id'] ?>?print=1" class="btn btn-outline-secondary" title="Print Report" target="_blank">
                                            <i class="bi bi-printer"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>

<!-- Quick Generate Modal -->
<div class="modal fade" id="generateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-lightning me-2"></i>Generate Report
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickGenerateForm" method="POST" action="/reports/ai/generate-template">
                <?= csrf_field() ?>
                <div class="modal-body">
                    <input type="hidden" name="report_type" id="modalReportType">

                    <div class="text-center mb-4">
                        <div id="modalIcon" class="template-icon bg-primary bg-opacity-10 text-primary rounded-circle mx-auto mb-3">
                            <i class="bi bi-bar-chart-line"></i>
                        </div>
                        <h5 id="modalTitle">Quarterly Performance Report</h5>
                        <p class="text-muted small" id="modalDescription">Generate a comprehensive quarterly performance analysis</p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Quarter</label>
                        <div class="btn-group w-100" role="group">
                            <?php for ($q = 1; $q <= 4; $q++): ?>
                            <input type="radio" class="btn-check" name="quarter" id="modalQ<?= $q ?>" value="<?= $q ?>" <?= $q == current_quarter() ? 'checked' : '' ?>>
                            <label class="btn btn-outline-primary" for="modalQ<?= $q ?>">Q<?= $q ?></label>
                            <?php endfor; ?>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Directorate (Optional)</label>
                        <select name="directorate_id" class="form-select">
                            <option value="">Organization-wide Report</option>
                            <?php foreach ($directorates as $d): ?>
                            <option value="<?= $d['id'] ?>"><?= e($d['code']) ?> - <?= e($d['name']) ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="modalGenerateBtn">
                        <i class="bi bi-lightning me-1"></i>Generate Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.template-icon {
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
}

.template-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.template-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.template-card.selected {
    box-shadow: 0 0 0 3px var(--bs-primary);
}

.btn-generate {
    transition: all 0.2s ease;
}

.btn-generate:hover {
    transform: scale(1.02);
}

.table tbody tr {
    transition: background-color 0.2s ease;
}

.card-header.bg-gradient {
    background: linear-gradient(135deg, var(--bs-primary) 0%, #4f46e5 100%) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateModal = new bootstrap.Modal(document.getElementById('generateModal'));

    const templateConfig = {
        'quarterly_performance': {
            title: 'Quarterly Performance Report',
            description: 'Generate a comprehensive quarterly performance analysis with KPI achievements and trends',
            icon: 'bi-bar-chart-line',
            color: 'primary'
        },
        'directorate_analysis': {
            title: 'Directorate Analysis Report',
            description: 'In-depth analysis of directorate performance with resource utilization metrics',
            icon: 'bi-diagram-3',
            color: 'success'
        },
        'budget_analysis': {
            title: 'Budget Analysis Report',
            description: 'Financial performance review with CAPEX/OPEX utilization and MFMA compliance',
            icon: 'bi-currency-dollar',
            color: 'info'
        },
        'risk_assessment': {
            title: 'Risk Assessment Report',
            description: 'Comprehensive risk evaluation with mitigation strategies and priority actions',
            icon: 'bi-shield-exclamation',
            color: 'danger'
        }
    };

    // Handle template card button clicks
    document.querySelectorAll('.btn-generate').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const type = this.dataset.type;
            const config = templateConfig[type];

            document.getElementById('modalReportType').value = type;
            document.getElementById('modalTitle').textContent = config.title;
            document.getElementById('modalDescription').textContent = config.description;

            const iconEl = document.getElementById('modalIcon');
            iconEl.className = `template-icon bg-${config.color} bg-opacity-10 text-${config.color} rounded-circle mx-auto mb-3`;
            iconEl.innerHTML = `<i class="bi ${config.icon}"></i>`;

            const generateBtn = document.getElementById('modalGenerateBtn');
            generateBtn.className = `btn btn-${config.color}`;

            // Update radio button styles
            document.querySelectorAll('#generateModal .btn-outline-primary').forEach(label => {
                label.className = label.className.replace('btn-outline-primary', `btn-outline-${config.color}`);
            });

            generateModal.show();
        });
    });

    // Handle card clicks
    document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.closest('.btn-generate')) return;
            this.querySelector('.btn-generate').click();
        });
    });

    // Sync custom form with AI form (if available)
    const reportTypeSelect = document.getElementById('reportType');
    const quarterRadios = document.querySelectorAll('input[name="quarter"]');
    const directorateSelect = document.getElementById('directorateId');

    if (document.getElementById('aiReportType')) {
        reportTypeSelect.addEventListener('change', function() {
            document.getElementById('aiReportType').value = this.value;
        });

        quarterRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('aiQuarter').value = this.value;
            });
        });

        directorateSelect.addEventListener('change', function() {
            document.getElementById('aiDirectorate').value = this.value;
        });
    }

    // Show loading state on form submit
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function() {
            const btn = this.querySelector('button[type="submit"]');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
            }
        });
    });
});
</script>
